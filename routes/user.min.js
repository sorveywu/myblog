var express=require("express");var router=express.Router();var crypto=require("crypto");var User=require("../model/user");router.get("/",function(b,a){a.send("user page");
});router.get("/login",function(b,a){a.render("login",{title:"用户登录"});});router.post("/login",function(c,b){var d=c.body.username,a=c.body.password;b.redirect("login");
});router.get("/reg",checkNotLogin);router.get("/reg",function(b,a){a.render("reg",{title:"用户注册",error:b.flash("error").toString()});});router.post("/reg",function(e,c){var b=e.body.email,a=e.body.password,d=e.body.repassword;
if(a!=d){e.flash("error","密码与确认密码不一致！");c.redirect("reg");}else{User.findByEmail(b,function(g,j){if(g){}else{if(j){e.flash("error","该邮箱已注册！");c.redirect("reg");
}else{var i=crypto.createHash("md5");var f=crypto.createHash("md5");var h={email:{normal:b,md5:i.update(b).digest("hex")},password:f.update(a).digest("hex")};
console.log(h);e.flash("success","用户注册成功，请登录！");c.redirect("login");}}});}});function checkLogin(c,a,b){if(!c.session.user){c.flash("error","用户未登录");a.redirect("login");
}b();}function checkNotLogin(c,a,b){if(c.session.user){c.flash("error","已登录");a.redirect("back");}b();}module.exports=router;